# app.py
# -*- coding: utf-8 -*-
# Streamlit App ‚Äî NOAA NWPS Gauge Network Map (Google Satellite base)

import streamlit as st
import requests
import folium
from streamlit_folium import st_folium
import pandas as pd
import time
import plotly.express as px

# ---------------- Streamlit Setup ----------------
st.set_page_config(page_title="Kentucky River Gauge Map", layout="wide")
st.title("üíß Kentucky River & Stream Gauges ‚Äî NOAA NWPS")
st.caption("Live stage and flow data for river gauges across Kentucky using NOAA's NWPS API.")

# ---------------- Refresh Button ----------------
refresh = st.button("üîÑ Refresh Data")

# ---------------- Embedded Station Data ----------------
station_data_string =  """site_no station_nm      lat     lon
03207965        GRAPEVINE CREEK NEAR PHYLLIS, KY        37.43260479     -82.3537563
03208000        LEVISA FORK BELOW FISHTRAP DAM NEAR MILLARD, KY 37.42593725     -82.4123701
03209325        ELKHORN CREEK AT BURDINE, KY    37.1878333      -82.6045694
03209410        RUSSELL FORK AT CEDARVILLE, KY  37.31295507     -82.3595549
03209500        LEVISA FORK AT PIKEVILLE, KY    37.4642676      -82.5262632
03209800        LEVISA FORK AT PRESTONSBURG, KY 37.67093027     -82.7771043
03210000        JOHNS CREEK NEAR META, KY       37.5670444      -82.45792659
03211500        JOHNS CREEK NEAR VAN LEAR, KY   37.74370748     -82.72404689
03212500        LEVISA FORK AT PAINTSVILLE, KY  37.81537197     -82.7915493
03213700        TUG FORK AT WILLIAMSON, WV      37.67315699     -82.2801408
03215000        BIG SANDY R AT LOUISA, KY       38.17119708     -82.6346023
03215410        BLAINE CREEK NEAR BLAINE, KY    38.0295332      -82.846829
03216000        OHIO RIVER AT ASHLAND, KY       38.4840255      -82.6415499
03216350        LITTLE SANDY RIVER BELOW GRAYSON DAM NEAR LEON, KY      38.25397068     -82.9910027
03216500        LITTLE SANDY RIVER AT GRAYSON, KY       38.3300813      -82.9393353
03216600        OHIO RIVER AT GREENUP DAM NEAR GREENUP, KY      38.6467448      -82.860447
03216777        TYGARTS CREEK AT LAWTON RD AT OLIVE HILL,KY     38.29038098     -83.1895603
03217000        TYGARTS CREEK NEAR GREENUP, KY  38.5642453      -82.9521158
03238000        OHIO RIVER AT MAYSVILLE, KY     38.68410948     -83.7838888
03238140        TAYLOR CREEK AT DONNERMEYER DRIVE AT BELLEVUE, KY       39.0974212      -84.48360879
03238745        TWELVEMILE CREEK AT HIGHWAY 1997 NR ALEXANDRIA, KY      38.9514529      -84.3382712
03238772        FOURMILE CREEK AT POPLAR RIDGE RD NR ALEXANDRIA,KY      38.98666667     -84.3652778
03238785        FOURMILE CK AT GRAYS CROSSING AT SILVER GROVE, KY       39.02125097     -84.3812115
03238798        FOURMILE CREEK AT HWY 8 AT SILVER GROVE, KY     39.0435753      -84.4197764
03248300        LICKING RIVER BELOW MASON FORK NR SALYERSVILLE, KY      37.73064817     -83.0579478
03249500        LICKING RIVER AT FARMERS, KY    38.11535945     -83.5432431
03249505        LICKING RIVER AT HWY 60 AT FARMERS, KY  38.14008125     -83.5571327
03250100        NORTH FORK TRIPLETT CREEK NEAR MOREHEAD, KY     38.1992478      -83.4804635
03250118        SALT LICK AT HWY 60 AT SALT LICK, KY    38.1213611      -83.6159694
03250190        SLATE CREEK AT HIGHWAY 713 NR MT. STERLING, KY  38.02396899     -83.8315854
03250322        ROCK LICK CR AT STATE HWY 158 NR SHARKEY, KY STA D      38.24730198     -83.5893567
03250500        LICKING RIVER AT BLUE LICK SPRINGS, KY  38.4200749      -83.9974261
03251200        NORTH FORK LICKING RIVER NEAR MT OLIVET, KY     38.5947955      -84.0202056
03251500        LICKING RIVER AT MCKINNEYSBURG, KY      38.60007244     -84.2663239
03251900        STONER CREEK AT WATER PLANT AT PARIS, KY        38.205  -84.2380556
03251980        HOUSTON CREEK AT HWY 27 NEAR PARIS, KY  38.19027778     -84.2816667
03252300        HINKSTON CREEK NEAR CARLISLE, KY        38.2474368      -84.05514979
03252500        SOUTH FORK LICKING RIVER AT CYNTHIANA, KY       38.390908       -84.3029905
03253000        SOUTH FORK LICKING RIVER AT HAYES, KY   38.6586817      -84.3518814
03253500        LICKING RIVER AT CATAWBA, KY    38.7103478      -84.3107693
03254520        LICKING RIVER AT HWY 536 NEAR ALEXANDRIA, KY    38.9203417      -84.44799549
03254550        BANKLICK CREEK @ HIGHWAY 1829 NR ERLANGER, KY   38.98055556     -84.5416667
03254693        THREEMILE CREEK AT THREE MILE ROAD AT COVINGTON,KY      39.05020525     -84.4850474
03260015        PLEASANT RUN CREEK AT OAK STREET NEAR LUDLOW, KY        39.0851154      -84.5581381
03260050        DRY CREEK AT SEWAGE PLANT NEAR ERLANGER, KY     39.0605833      -84.6199167
03260100        ELIJAHS CREEK @ ELIJAHS CREEK RD NR HEBRON, KY  39.0797222      -84.6852778
03260270        SAND RUN AT THORNWILDE DR AT FRANCISVILLE, KY   39.1045833      -84.7291944
03262001        WOOLPER CREEK AT WOOLPER ROAD NEAR BURLINGTON, KY       39.03   -84.8041667
03277075        GUNPOWDER CR AT CAMP ERNST RD NR UNION, KY      38.99416667     -84.7161111
03277130        MUD LICK CR AT HWY 42 NR BEAVERLICK, KY 38.84504677     -84.7207555
03277200        OHIO RIVER AT MARKLAND DAM NEAR WARSAW, KY      38.77525        -84.97238889
03277300        NORTH FORK KENTUCKY RIVER AT WHITESBURG, KY     37.11759849     -82.82460429
03277450        CARR FORK NEAR SASSAFRAS, KY    37.2333194      -83.0337562
03277500        NORTH FORK KENTUCKY RIVER AT HAZARD, KY 37.2465833      -83.1827778
03280000        NORTH FORK KENTUCKY RIVER AT JACKSON, KY        37.55231228     -83.3857358
03280612        MIDDLE FORK KENTUCKY RIVER AT HWY 2431 AT HYDEN,KY      37.1462029      -83.3812933
03280700        CUTSHIN CREEK AT WOOTON, KY     37.1650931      -83.3079564
03280790        TRACE BR AT TRACE BR CAMPGROUND AT CONFLUENCE, KY       37.2719861      -83.3698472
03280902        MIDDLE FK KENTUCKY RIVER AT HWY28 NR BUCKHORN, KY       37.34327778     -83.4478611
03281000        MIDDLE FORK KENTUCKY RIVER AT TALLEGA, KY       37.55508768     -83.5937993
03281100        GOOSE CREEK AT MANCHESTER, KY   37.15203405     -83.7601974
03281500        SOUTH FORK KENTUCKY RIVER AT BOONEVILLE, KY     37.47981018     -83.6751923
03282000        KENTUCKY RIVER AT LOCK 14 AT HEIDELBERG, KY     37.5531418      -83.7693625
03282040        STURGEON CREEK AT CRESSMONT, KY 37.5006422      -83.8101979
03282060        KENTUCKY RIVER AT LOCK 13 NEAR WILLOW SHOALS, KY        37.60189058     -83.83336439
03282120        KENTUCKY RIVER AT LOCK 12 NEAR IRVINE, KY       37.6783333      -83.9483333
03282290        KENTUCKY RIVER AT LOCK 11 NEAR COLLEGE HILL, KY 37.78396929     -84.1032602
03282500        RED RIVER NEAR HAZEL GREEN, KY  37.80925288     -83.45768398
03283500        RED RIVER AT CLAY CITY, KY      37.86480329     -83.9335328
03284000        KENTUCKY RIVER AT LOCK 10 NEAR WINCHESTER, KY   37.89396779     -84.26048609
03284230        KENTUCKY RIVER AT LOCK 9 AT VALLEY VIEW, KY     37.843968       -84.44063039
03284500        KENTUCKY RIVER AT LOCK 8 NEAR CAMP NELSON, KY   37.74535715     -84.5866074
03284525        E HICKMAN CR TRIB AT CHILESBURG RD NR LEXINGTON,KY      37.98841157     -84.4110465
03284533        EAST HICKMAN CR AT TATES CR RD NR EAST HICKMAN, KY      37.9383333      -84.4786111
03284552        WEST HICKMAN CR AT VETERANS PARK NR LEXINGTON, KY       37.95777778     -84.5011111
03285000        DIX RIVER NEAR DANVILLE, KY     37.6420234      -84.6607768
03286200        DIX RIVER AT DIX DAM NEAR BURGIN, KY    37.7931339      -84.7060566
03286500        KENTUCKY RIVER AT LOCK 7 AT HIGHBRIDGE, KY      37.8292447      -84.723835
03287000        KENTUCKY RIVER AT LOCK 6 NEAR SALVISA, KY       37.92563166     -84.8213381
03287250        KENTUCKY RIVER AT LOCK 5 NEAR TYRONE, KY        38.0528805      -84.8311989
03287500        KENTUCKY RIVER AT LOCK 4 AT FRANKFORT, KY       38.2113333      -84.8741111
03287590        N ELKHORN CR AT WINCHESTER RD NR LEXINGTON, KY  38.04006944     -84.4111111
03287600        N ELKHORN CR AT BRYAN STATION RD AT MONTROSE, KY        38.07646608     -84.4132694
03288100        NORTH ELKHORN CREEK AT GEORGETOWN, KY   38.2195187      -84.562998
03288110        ROYAL SPRINGS AT GEORGETOWN, KY 38.20951888     -84.5618868
03288180        CANE RUN CREEK AT CITATION BLVD NR LEXINGTON, KY        38.09166667     -84.50138889
03288190        TRIB TO CANE RUN CR AT NEWTOWN PK NR LEXINGTON, KY      38.1136111      -84.4827778
03289000        SOUTH ELKHORN CREEK AT FORT SPRING, KY  38.0431322      -84.6263318
03289193        WOLF RUN AT OLD FRANKFORT PIKE AT LEXINGTON, KY 38.06674334     -84.5543852
03289200        TOWN BRANCH AT YARNALLTON ROAD AT YARNALLTON, KY        38.103687       -84.5879977
03289300        SOUTH ELKHORN CREEK NEAR MIDWAY, KY     38.1409082      -84.645222
03289500        ELKHORN CREEK NEAR FRANKFORT, KY        38.26868254     -84.8146714
03290080        KENTUCKY RIVER AT LOCK 3 AT GEST, KY    38.4167353      -84.8807829
03290500        KENTUCKY RIVER AT LOCK 2 AT LOCKPORT, KY        38.43895654     -84.9632844
03291000        EAGLE CREEK AT SADIEVILLE, KY   38.38951686     -84.5432759
03291500        EAGLE CREEK AT GLENCOE, KY      38.7064538      -84.8248089
03291585        KENTUCKY RIVER AT LOCK 1 NEAR CARROLLTON, KY    38.65870475     -85.144789
03292470        HARRODS CREEK AT HIGHWAY 329 NR GOSHEN, KY.     38.36117864     -85.57459969
03292474        GOOSE CREEK AT OLD WESTPORT RD NR ST MATTHEWS, KY       38.2759036      -85.606072
0329247450      GOOSE CREEK AT HWY 22 AT SPRING VALLEY, KY      38.29233889     -85.61085
03292475        GOOSE CREEK AT US HWY 42 NEAR GLENVIEW ACRES, KY        38.3034027      -85.62801689
03292480        LITTLE GOOSE CREEK NEAR HARRODS CREEK, KY       38.3127635      -85.6261558
03292494        OHIO RIVER AT WATER TOWER AT LOUISVILLE, KY     38.2811812      -85.7021843
03292500        SOUTH FORK BEARGRASS CREEK AT LOUISVILLE, KY    38.2114592      -85.7024613
03292550        S FK BEARGRASS CREEK AT E OAK ST AT LOUISVILLE, KY      38.23368333     -85.72962222
03293000        M FK BEARGRASS CR AT OLD CANNONS LN AT LOUISVILLE,      38.237293       -85.6646834
03293500        M FK BEARGRASS CR AT LEXINGTON RD AT LOUISVILLE,KY      38.25034895     -85.7166287
03293510        BEARGRASS CREEK AT RIVER ROAD AT LOUISVILLE, KY 38.26590398     -85.7207955
03293530        MUDDY FK AT MOCKINGBIRD VALLEY RD AT LOUISVILLE,KY      38.27645917     -85.693573
03293551        OHIO R US OF MCALPINE DAM @ RRB AT LOUISVILLE, KY       38.26590376     -85.7688518
03294500        OHIO RIVER AT LOUISVILLE, KY    38.28034736     -85.7991305
03294550        MILL CREEK CUTOFF NEAR LOUISVILLE, KY   38.1775699      -85.8669086
03294560        OHIO RIVER BELOW RIVERVIEW PK NR LOUISVILLE, KY 38.1347111      -85.9012306
03294570        MILL CREEK AT ORELL ROAD NEAR LOUISVILLE, KY    38.07812588     -85.8899635
03295400        SALT RIVER AT GLENSBORO, KY     38.00201594     -85.0605085
03295890        BRASHEARS CREEK AT TAYLORSVILLE, KY     38.0370083      -85.3407867
03297800        CEDAR CREEK AT HWY 1442 NEAR SHEPHERDSVILLE, KY 37.9911111      -85.6411111
03297900        FLOYDS FORK NEAR PEWEE VALLEY, KY       38.28534776     -85.4674592
03298000        FLOYDS FORK AT FISHERVILLE, KY  38.18840166     -85.460235
03298135        CHENOWETH RUN AT RUCKRIEGAL PARKWAY, KY 38.19479109     -85.557181
03298150        CHENOWETH RUN AT GELHAUS LANE NEAR FERN CREEK, KY       38.16006729     -85.5421797
03298200        FLOYDS FORK NEAR MT WASHINGTON, KY      38.08534216     -85.5549556
03298250        CEDAR CREEK AT THIXTON ROAD NEAR LOUISVILLE, KY 38.0792321      -85.6160683
03298300        PENNSLYVANIA RUN AT MT WASHINGTON RD NR LOUISVILLE      38.08756629     -85.642458
03298470        FLOYDS FORK NEAR SHEPHERDSVILLE, KY     38.0033983      -85.68218
03298500        SALT RIVER AT SHEPHERDSVILLE, KY        37.98506585     -85.7174591
03298550        LONG LICK AT CLERMONT, KY       37.92784138     -85.6535688
03298940        ROLLING FORK AT HWY 208 AT CALVARY, KY  37.5125 -85.2611111
03299500        ROLLING FORK AT NEW HAVEN, KY   37.6495063      -85.5974617
03300400        BEECH FORK AT MAUD, KY  37.83283985     -85.2960686
03301000        BEECH FORK AT BARDSTOWN, KY     37.79700569     -85.4807919
03301500        ROLLING FORK NEAR BOSTON, KY    37.7672853      -85.7038488
03301630        ROLLING FORK NEAR LEBANON JUNCTION, KY  37.82284205     -85.7477377
03301900        FERN CREEK AT OLD BARDSTOWN RD AT LOUISVILLE, KY        38.1756242      -85.615237
03301940        NORTHERN DITCH AT OKOLONA, KY   38.1492 -85.6788
03302000        POND CREEK NEAR LOUISVILLE, KY  38.1197916      -85.7957955
03302030        POND CREEK AT PENDLETON ROAD NEAR LOUISVILLE, KY        38.05423677     -85.8716296
03302050        BRIER CREEK AT PENDELTON ROAD NEAR LOUISVILLE, KY       38.04693096     -85.8572681
03302058        SALT RIVER AT MAIN RANGE RD NR WEST POINT, KY   37.99222222     -85.92205556
03303502        OHIO RIVER AT RIVERPORT AT OWENSBORO, KY        37.7936111      -87.1416111
03305000        GREEN RIVER NEAR MCKINNEY, KY   37.42202127     -84.7502243
03306000        GREEN RIVER NEAR CAMPBELLSVILLE, KY     37.2403413      -85.3471848
03306500        GREEN RIVER AT GREENSBURG, KY   37.2536713      -85.5030215
03307000        RUSSELL CREEK NEAR COLUMBIA, KY 37.12547797     -85.4040748
03308500        GREEN RIVER AT MUNFORDVILLE, KY 37.26944444     -85.8880556
03309000        GREEN RIVER AT MAMMOTH CAVE, KY 37.18004845     -86.1124757
03310000        NORTH FORK NOLIN RIVER AT HODGENVILLE, KY       37.57805556     -85.7536111
03310300        NOLIN RIVER AT WHITE MILLS, KY  37.56200389     -86.0366333
03310400        BACON CREEK NEAR PRICEVILLE, KY 37.349875       -85.96587222
03311000        NOLIN RIVER AT KYROCK, KY       37.2742157      -86.2508064
03311513        GREEN RIVER AT HWY 259 AT BROWNSVILLE, KY       37.19719444     -86.27325
03313000        BARREN RIVER NEAR FINNEY, KY    36.89504634     -86.1338731
03313700        WEST FORK DRAKES CREEK NEAR FRANKLIN, KY        36.7233738      -86.5522175
03314000        DRAKES CREEK NEAR ALVATON, KY   36.89531974     -86.380546
03314500        BARREN RIVER AT BOWLING GREEN, KY       37.0028201      -86.432768
03315500        GREEN RIVER AT LOCK 4 AT WOODBURY, KY   37.18226814     -86.62998829
03315850        GREEN RIVER AT ROCHESTER, KY    37.21566667     -86.8935556
03316500        GREEN RIVER AT PARADISE, KY     37.2639316      -86.9777726
03316645        GREEN RIVER AT ROCKPORT, KY     37.33532185     -87.002773
03318010        ROUGH RIVER NEAR FALLS OF ROUGH AT DAM, KY      37.62199988     -86.5041474
03318800        CANEY CREEK NEAR HORSE BRANCH, KY       37.4639398      -86.6555419
03319000        ROUGH RIVER NEAR DUNDEE, KY     37.5475514      -86.7216546
03319885        GREEN RIVER AT LIVERMORE, KY    37.48560237     -87.1363854
03320000        GREEN RIVER AT LOCK 2 AT CALHOUN, KY    37.533935       -87.2638873
03320500        POND RIVER NEAR APEX, KY        37.1222655      -87.3194431
03321350        SOUTH FORK PANTHER CREEK NEAR WHITESVILLE, KY   37.6189392      -86.88749179
03321500        GREEN RIVER AT LOCK 1 AT SPOTTSVILLE, KY        37.8583774      -87.4097294
03322190        OHIO RIVER AT HENDERSON, KY     37.84559817     -87.5922359
03322420        OHIO RIVER AT UNIONTOWN DAM, KY 37.79715556     -87.9983356
03381700        OHIO RIVER AT OLD SHAWNEETOWN, IL-KY    37.6925 -88.1347222
03383000        TRADEWATER RIVER AT OLNEY, KY   37.22393575     -87.7805659
03384100        TRADEWATER RIVER NEAR PROVIDENCE, KY    37.39671307     -87.8450154
03400500        POOR FORK AT CUMBERLAND, KY     36.97398059     -82.99294
03400785        MARTINS FORK ABOVE SMITH, KY    36.72619838     -83.287958
03400800        MARTINS FORK NEAR SMITH, KY     36.75230974     -83.2574012
03400986        MARTIN'S FORK NEAR HARLAN, KY   36.8445329      -83.3235148
03401000        CUMBERLAND RIVER NEAR HARLAN, KY        36.84675484     -83.3557386
03402900        CUMBERLAND R AT PINE ST BR AT PINEVILLE, KY     36.7631412      -83.691862
03403500        CUMBERLAND RIVER AT BARBOURVILLE, KY    36.8623097      -83.8874248
03403910        CLEAR FORK AT SAXTON, KY        36.63397105     -84.1115969
03404000        CUMBERLAND RIVER AT WILLIAMSBURG, KY    36.743417       -84.1560449
03404500        CUMBERLAND RIVER AT CUMBERLAND FALLS, KY        36.8373036      -84.3432703
03404820        LAUREL RIVER AT MUNICIPAL DAM NEAR CORBIN, KY   36.97036505     -84.1196543
03404900        LYNN CAMP CREEK AT CORBIN, KY   36.9514765      -84.0935427
03406500        ROCKCASTLE RIVER AT BILLOWS, KY 37.1711952      -84.296047
03407500        BUCK CREEK NEAR SHOPVILLE, KY   37.21063659     -84.4643845
03410500        SOUTH FORK CUMBERLAND RIVER NEAR STEARNS, KY    36.62702209     -84.5332723
03413200        BEAVER CREEK NEAR MONTICELLO, KY        36.79757036     -84.89605849
03414000        CUMBERLAND RIVER NEAR ROWENA, KY        36.88395484     -85.1394008
03414078        CROCUS CREEK NEAR AMANDAVILLE, KY       36.88702778     -85.3302861
03414100        CUMBERLAND RIVER AT BURKESVILLE, KY     36.78674648     -85.3652223
03414170        MARROWBONE CK AT MUD CAMP RD AT WATERVIEW, KY   36.81513889     -85.4588333
03435105        RED RIVER AT DOT, KY    36.6766583      -86.9520861
03437370        N FK LITTLE R AT WATER PLANT AT HOPKINSVILLE, KY        36.8761561      -87.47195119
03437480        S FK LITTLE RIVER AT HWY 68/80 NR HOPKINSVILLE, KY      36.8497664      -87.3522269
03437495        S FK LITTLE R AT HWY 68 BY-PASS AT HOPKINSVILLE,KY      36.84948934     -87.4288954
03437500        SOUTH FORK LITTLE RIVER AT HOPKINSVILLE, KY     36.8394899      -87.481397
03610200        CLARKS RIVER AT ALMO, KY        36.6917217      -88.273647
03611000        OHIO RIVER AT PADUCAH, KY       37.0895004      -88.594492
03611260        MASSAC CREEK NEAR PADUCAH, KY   37.04144404     -88.7108852
07023000        MAYFIELD CREEK AT LOVELACEVILLE, KY     36.9525769      -88.825053
07023700        OBION CREEK NEAR ARLINGTON, KY  36.7583908      -89.0036748
07024000        BAYOU DE CHIEN NEAR CLINTON, KY 36.6286707      -88.963951
371016082381001 ELKHORN CREEK AT FREEDOM LANE AT JENKINS, KY    37.17107222     -82.63613056
371144082383401 ELKHORN CREEK AT BARNHILL RD NR DUNHAM, KY      37.19571667     -82.6428778
""" # (You can paste your full dataset here)

stations_df = pd.read_csv(pd.io.common.StringIO(station_data_string), delim_whitespace=True)

# ---------------- Fetch NOAA NWPS Data ----------------
@st.cache_data(ttl=600)
def fetch_noaa_data(stations):
    base_url = "https://api.water.noaa.gov/nwps/v1/gauges/{id}/stageflow"
    responses = {}
    for s in stations:
        url = base_url.format(id=s)
        try:
            r = requests.get(url, timeout=10)
            r.raise_for_status()
            responses[s] = r.json()
            time.sleep(0.1)
        except requests.exceptions.RequestException:
            responses[s] = None
    return responses

if refresh or "noaa_data" not in st.session_state:
    with st.spinner("Fetching latest gauge data from NOAA..."):
        st.session_state["noaa_data"] = fetch_noaa_data(stations_df["site_no"].tolist())

responses = st.session_state["noaa_data"]

# ---------------- Map Setup (Google Satellite) ----------------
avg_lat = stations_df["lat"].mean()
avg_lon = stations_df["lon"].mean()
m = folium.Map(
    location=[avg_lat, avg_lon],
    zoom_start=7,
    control_scale=True,
    tiles=None
)
folium.TileLayer(
    tiles="https://mt1.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}",
    attr="Google Satellite",
    name="Google Satellite",
    overlay=False,
    control=True,
).add_to(m)

valid_count = 0

# ---------------- Add Markers ----------------
for _, row in stations_df.iterrows():
    site = row["site_no"]
    lat, lon = row["lat"], row["lon"]
    data = responses.get(site, None)
    color = "red"
    popup_html = f"<b>Station:</b> {site}<br><b>Name:</b> {row['station_nm']}<br>"

    if data and isinstance(data, dict):
        valid_count += 1
        color = "blue"
        popup_html += f"<b>Valid Time:</b> {data.get('validTime','N/A')}<br>"
        popup_html += f"<b>Generated Time:</b> {data.get('generatedTime','N/A')}<br>"
        popup_html += f"<b>Primary:</b> {data.get('primary','N/A')}<br>"
        popup_html += f"<b>Secondary:</b> {data.get('secondary','N/A')}"

        # Add observed data if present
        if "observed" in data and "data" in data["observed"]:
            obs = data["observed"]["data"][-1] if data["observed"]["data"] else {}
            if obs:
                popup_html += f"<br><b>Most Recent Observation:</b> {obs}"
    else:
        popup_html += "‚ö†Ô∏è No API data"

    folium.CircleMarker(
        location=[lat, lon],
        radius=6,
        color=color,
        fill=True,
        fill_opacity=0.9,
        popup=folium.Popup(popup_html, max_width=300),
        tooltip=f"{row['station_nm']} ({site})"
    ).add_to(m)

folium.LayerControl().add_to(m)

# ---------------- Map Display ----------------
st.markdown(f"**Total Stations:** {len(stations_df)} | ‚úÖ Successful: {valid_count} | ‚ö†Ô∏è Failed: {len(stations_df)-valid_count}")
st_map = st_folium(m, width=1000, height=650)

# ---------------- Sidebar: Station Details ----------------
st.sidebar.header("üìä Station Data Viewer")
selected_station = st.sidebar.selectbox("Select a Station", stations_df["site_no"].tolist())

if selected_station:
    data = responses.get(selected_station)
    if data and isinstance(data, dict) and "observed" in data and "data" in data["observed"]:
        obs_df = pd.DataFrame(data["observed"]["data"])
        if not obs_df.empty:
            obs_df["time"] = pd.to_datetime(obs_df["validTime"], errors="coerce")
            obs_df = obs_df.dropna(subset=["time"])
            y_col = "primary" if "primary" in obs_df.columns else obs_df.columns[1]
            fig = px.line(
                obs_df,
                x="time",
                y=y_col,
                title=f"Observed {y_col} ‚Äî Station {selected_station}",
                labels={y_col: y_col.capitalize(), "time": "Time (UTC)"},
            )
            st.sidebar.plotly_chart(fig, use_container_width=True)
        else:
            st.sidebar.warning("No observation data available for this station.")
    else:
        st.sidebar.warning("No data available for this station.")
